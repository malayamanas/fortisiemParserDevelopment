import xml.etree.ElementTree as ET
from parser_studio.generator import generate_parser

BASIC_META = {
    "name": "TestParser", "scope": "enabled", "parser_type": "User",
    "vendor": "Acme", "model": "Firewall", "version": "ANY",
    "anchor": "ACME_FW",
}

BASIC_MAPPINGS = {
    "srcip": "srcIpAddr",
    "dstip": "destIpAddr",
    "action": "eventAction",
}


def _wrap(fragment: str) -> ET.Element:
    """Wrap a parser fragment in <eventParser> so ET can parse it."""
    return ET.fromstring(f"<eventParser>{fragment}</eventParser>")


def test_generates_parseable_fragment():
    """Generated output must be parseable when wrapped in <eventParser>."""
    xml_str = generate_parser(BASIC_META, BASIC_MAPPINGS, "syslog+kv", [])
    root = _wrap(xml_str)   # must not raise
    assert root is not None

def test_fragment_has_pattern_definitions():
    xml_str = generate_parser(BASIC_META, BASIC_MAPPINGS, "syslog+kv", [])
    assert "<patternDefinitions>" in xml_str

def test_recognizer_before_pattern_definitions():
    """<eventFormatRecognizer> must appear before <patternDefinitions>."""
    xml_str = generate_parser(BASIC_META, BASIC_MAPPINGS, "syslog+kv", [])
    assert xml_str.index("<eventFormatRecognizer>") < xml_str.index("<patternDefinitions>")

def test_recognizer_is_single_line():
    """<eventFormatRecognizer> must open and close on the same line (no nesting)."""
    for line in generate_parser(BASIC_META, BASIC_MAPPINGS, "syslog+kv", []).splitlines():
        if "<eventFormatRecognizer>" in line:
            assert "</eventFormatRecognizer>" in line
            break

def test_no_studio_header_comments():
    xml_str = generate_parser(BASIC_META, BASIC_MAPPINGS, "syslog+kv", [])
    assert "Generated by Parser Studio" not in xml_str

def test_fragment_has_no_event_parser_wrapper():
    xml_str = generate_parser(BASIC_META, BASIC_MAPPINGS, "syslog+kv", [])
    assert "<eventParser" not in xml_str

def test_fragment_has_no_device_type():
    """Metadata is stored in DB columns, not in the XML fragment."""
    xml_str = generate_parser(BASIC_META, BASIC_MAPPINGS, "syslog+kv", [])
    assert "<Vendor>" not in xml_str
    assert "<deviceType>" not in xml_str

def test_json_format_uses_correct_extraction():
    xml_str = generate_parser(BASIC_META, {"threatName": "msg"}, "syslog+json", [])
    assert "collectAndSetAttrByJSON" in xml_str

def test_kv_format_uses_correct_extraction():
    xml_str = generate_parser(BASIC_META, BASIC_MAPPINGS, "syslog+kv", [])
    assert "collectAndSetAttrByKeyValuePair" in xml_str

def test_xml_format_uses_xpath():
    xml_str = generate_parser(BASIC_META, {"Event.System.EventID": "winEventId"}, "syslog+xml", [])
    assert "collectFieldsByXPath" in xml_str

def test_no_double_dash_in_comments():
    xml_str = generate_parser(BASIC_META, BASIC_MAPPINGS, "syslog+kv", [])
    import re
    assert not re.search(r'<!--.*?--.*?-->', xml_str)

def test_has_event_severity_default():
    xml_str = generate_parser(BASIC_META, BASIC_MAPPINGS, "syslog+kv", [])
    assert 'attr="eventSeverity"' in xml_str

def test_has_event_type():
    xml_str = generate_parser(BASIC_META, BASIC_MAPPINGS, "syslog+kv", [])
    assert 'attr="eventType"' in xml_str
